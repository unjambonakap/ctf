#!/bin/bash

set -eu
mode=$1; shift

if [[ $mode -eq 1 ]]; then

    cmd="""
import re
data=input()
res=re.findall('saloon\(([0-9]*)\)', data)[1]
print(res, end='')
    """

    pid=$(pstree -p | grep saloon| python -c "$cmd")
    opt="--pid=$pid"
    gdb_cmdfile='/tmp/gdb_cmd'

    echo '
#set $offset=0x0000555555554000
#b *($offset+0x124e)
#b *($offset+0x1019)
#b *($offset+0x11c1)
#b *($offset+0x1175)
#b *($offset+0xf70)
#b *($offset+0x11fb)
#b *($offset+0x1064)
#b *($offset+0x1019)
c
    ' > $gdb_cmdfile

    sudo gdb -x $gdb_cmdfile ./saloon --pid=$pid

else

    gdb_cmdfile='/tmp/gdb_cmd'

    echo '
    set $offset=0x0000555555554000
    #b *($offset+0x1194)
b *($offset+0x124e)
    #b *($offset+0x1064)
    #b *($offset+0x12dc)
    #b *($offset+0xe3c)
    r
    x/g $offset+0x202010
    ' > $gdb_cmdfile


    sudo gdb -x $gdb_cmdfile ./saloon_patched
fi;
