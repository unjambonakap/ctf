/* This file has been generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2015 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int init_proc();
// void free(void *ptr);
// int puts(const char *s);
// int printf(const char *format, ...);
// ssize_t read(int fd, void *buf, size_t nbytes);
// int strcmp(const char *s1, const char *s2);
// void *malloc(size_t size);
// void *realloc(void *ptr, size_t size);
// int setvbuf(FILE *stream, char *buf, int modes, size_t n);
// int atoi(const char *nptr);
// int __fastcall _cxa_finalize(_QWORD); weak
signed int sub_860();
int sub_8A0();
signed int sub_8F0();
int sub_930();
void __fastcall main(__int64 a1, char **a2, char **a3);
int sub_BCE();
int sub_D07();
void *new_memo();
int view_memo();
int mod_memo();
void del_memo();
int sub_156D();
__int64 __fastcall read_str(__int64 a1, unsigned int a2);
int sub_18EC();
void __fastcall init(unsigned int a1, __int64 a2, __int64 a3);
void term_proc();
// int _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

_DWORD dword_19D4[7] = { 4294963187, 4294963139, 4294963151, 4294963163, 4294963175, 4294963202, 0 }; // idb
char byte_1AC9 = '\0'; // idb
__int64 (__fastcall *off_202D78)() = &sub_930; // weak
__int64 (__fastcall *off_202D80)() = &sub_8F0; // weak
void *off_203008 = &off_203008; // weak
FILE *stdout; // idb
FILE *stdin; // idb
FILE *stderr; // idb
char byte_203048; // weak
__int64 qword_203050; // weak
// extern _UNKNOWN __cxa_finalize; weak


//----- (0000000000000768) ----------------------------------------------------
int init_proc()
{
  int (**v0)(void); // rax@1

  v0 = &_gmon_start__;
  if ( &_gmon_start__ )
    LODWORD(v0) = _gmon_start__();
  return (unsigned __int64)v0;
}
// 203088: using guessed type int _gmon_start__(void);

//----- (0000000000000830) ----------------------------------------------------
#error "836: positive sp value has been found (funcsize=3)"

//----- (0000000000000860) ----------------------------------------------------
signed int sub_860()
{
  return 2109456;
}

//----- (00000000000008A0) ----------------------------------------------------
int sub_8A0()
{
  return 0;
}

//----- (00000000000008F0) ----------------------------------------------------
signed int sub_8F0()
{
  signed int result; // eax@4

  if ( !byte_203048 )
  {
    if ( &__cxa_finalize )
      _cxa_finalize(off_203008);
    result = sub_860();
    byte_203048 = 1;
  }
  return result;
}
// 820: using guessed type int __fastcall _cxa_finalize(_QWORD);
// 203008: using guessed type void *off_203008;
// 203048: using guessed type char byte_203048;

//----- (0000000000000930) ----------------------------------------------------
int sub_930()
{
  return sub_8A0();
}

//----- (000000000000093A) ----------------------------------------------------
void __fastcall main(__int64 a1, char **a2, char **a3)
{
  int v3; // [sp+Ch] [bp-4h]@2

  sub_BCE();
  sub_D07();
  while ( 1 )
  {
    sub_18EC();
    v3 = read_num();
    if ( (unsigned int)v3 <= 5 )
      break;
    puts("Illegal menu");
  }
  JUMPOUT(__CS__, (char *)dword_19D4 + dword_19D4[(unsigned __int64)(unsigned int)v3]);
}

//----- (0000000000000BCE) ----------------------------------------------------
int sub_BCE()
{
  int result; // eax@1

  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  result = setvbuf(stderr, 0LL, 2, 0LL);
  qword_203050 = 0LL;
  return result;
}
// 203050: using guessed type __int64 qword_203050;

//----- (0000000000000D07) ----------------------------------------------------
int sub_D07()
{
  puts("------------------------------------------------");
  puts("-                                              -");
  puts("-     Welcome to Automated Binary Compiler     -");
  puts("-    This binary is automatically compiled!    -");
  puts("-                                              -");
  puts("------------------------------------------------");
  return puts(&byte_1AC9);
}

//----- (0000000000000EA2) ----------------------------------------------------
void *new_memo()
{
  void *v0; // ST08_8@1
  unsigned __int16 v1; // ax@1
  unsigned __int16 v2; // ST06_2@1
  void *result; // rax@1

  v0 = malloc(0x28uLL);
  printf("New memo name: ");
  read_str((__int64)v0, 0x10u);
  printf("New memo length: ", 16LL);
  v1 = read_num();
  v2 = v1;
  *((_WORD *)v0 + 12) = v1;
  *((_QWORD *)v0 + 2) = malloc(v1);
  printf("New memo contents: ");
  read_str(*((_QWORD *)v0 + 2), v2);
  *((_QWORD *)v0 + 4) = qword_203050;
  result = v0;
  qword_203050 = (__int64)v0;
  return result;
}
// 203050: using guessed type __int64 qword_203050;

//----- (0000000000000FEF) ----------------------------------------------------
int view_memo()
{
  __int64 v0; // rax@1
  char s1; // [sp+0h] [bp-30h]@1
  char *s2; // [sp+28h] [bp-8h]@1

  printf("View memo name: ");
  read_str((__int64)&s1, 0x20u);
  LODWORD(v0) = qword_203050;
  for ( s2 = (char *)qword_203050; s2; s2 = (char *)*((_QWORD *)s2 + 4) )
  {
    LODWORD(v0) = strcmp(&s1, s2);
    if ( !(_DWORD)v0 )
      break;
    v0 = *((_QWORD *)s2 + 4);
  }
  if ( s2 )
  {
    printf("[%s]\n", s2);
    LODWORD(v0) = printf(*((const char **)s2 + 2));
  }
  return v0;
}
// 203050: using guessed type __int64 qword_203050;

//----- (000000000000115D) ----------------------------------------------------
int mod_memo()
{
  char *v0; // rsi@1
  __int64 v1; // rax@1
  char s1; // [sp+0h] [bp-30h]@1
  unsigned __int16 v4; // [sp+26h] [bp-Ah]@6
  char *s2; // [sp+28h] [bp-8h]@1

  printf("Modify memo name: ");
  v0 = (char *)32;
  read_str((__int64)&s1, 0x20u);
  LODWORD(v1) = qword_203050;
  for ( s2 = (char *)qword_203050; s2; s2 = (char *)*((_QWORD *)s2 + 4) )
  {
    v0 = s2;
    LODWORD(v1) = strcmp(&s1, s2);
    if ( !(_DWORD)v1 )
      break;
    v1 = *((_QWORD *)s2 + 4);
  }
  if ( s2 )
  {
    printf("New memo length: ", v0);
    v4 = read_num();
    if ( *((_WORD *)s2 + 12) < (signed __int16)v4 )
      *((_QWORD *)s2 + 2) = realloc(*((void **)s2 + 2), v4);
    *((_WORD *)s2 + 12) = v4;
    printf("New memo contents: ");
    LODWORD(v1) = read_str(*((_QWORD *)s2 + 2), v4);
  }
  return v1;
}
// 203050: using guessed type __int64 qword_203050;

//----- (00000000000012A5) ----------------------------------------------------
void del_memo()
{
  char s1; // [sp+0h] [bp-30h]@1
  char *v1; // [sp+20h] [bp-10h]@1
  char *s2; // [sp+28h] [bp-8h]@1

  printf("Delete memo name: ");
  read_str((__int64)&s1, 0x20u);
  v1 = 0LL;
  for ( s2 = (char *)qword_203050; s2; s2 = (char *)*((_QWORD *)s2 + 4) )
  {
    if ( !strcmp(&s1, s2) )
    {
      if ( v1 )
        *((_QWORD *)v1 + 4) = *((_QWORD *)s2 + 4);
      else
        qword_203050 = *((_QWORD *)s2 + 4);
      free(*((void **)s2 + 2));
      free(s2);
      return;
    }
    v1 = s2;
  }
}
// 203050: using guessed type __int64 qword_203050;

//----- (000000000000156D) ----------------------------------------------------
int sub_156D()
{
  char buf[208]; // [sp+0h] [bp-D0h]@1

  buf[read(0, buf, 0x1ACFuLL)] = 0;
  return atoi(buf);
}
// 156D: using guessed type char buf[208];

//----- (0000000000001643) ----------------------------------------------------
__int64 __fastcall read_str(__int64 a1, unsigned int a2)
{
  unsigned int v3; // [sp+1Ch] [bp-4h]@1

  v3 = 0;
  while ( (signed int)v3 < (signed int)a2 )
  {
    v3 += read(0, (void *)(a1 + (signed int)v3), (signed int)(a2 - v3));
    if ( (signed int)v3 > 0 && (!*(_BYTE *)((signed int)v3 - 1LL + a1) || *(_BYTE *)((signed int)v3 - 1LL + a1) == 10)
      || v3 == a2 )
    {
      *(_BYTE *)((signed int)v3 - 1LL + a1) = 0;
      return v3;
    }
  }
  return v3;
}

//----- (00000000000018EC) ----------------------------------------------------
int sub_18EC()
{
  puts("1. New memo");
  puts("2. View memo");
  puts("3. Modify memo");
  puts("4. Delete memo");
  puts("5. Exit");
  return printf(">> ");
}

//----- (0000000000001940) ----------------------------------------------------
void __fastcall init(unsigned int a1, __int64 a2, __int64 a3)
{
  __int64 v3; // r13@1
  signed __int64 v4; // rbp@1
  __int64 v5; // rbx@2

  v3 = a3;
  v4 = &off_202D80 - &off_202D78;
  init_proc();
  if ( v4 )
  {
    v5 = 0LL;
    do
      ((void (__fastcall *)(_QWORD, __int64, __int64))*(&off_202D78 + v5++))(a1, a2, v3);
    while ( v4 != v5 );
  }
}
// 202D78: using guessed type __int64 (__fastcall *off_202D78)();
// 202D80: using guessed type __int64 (__fastcall *off_202D80)();

//----- (00000000000019B4) ----------------------------------------------------
void term_proc()
{
  ;
}

#error "There were 1 decompilation failure(s) on 18 function(s)"
