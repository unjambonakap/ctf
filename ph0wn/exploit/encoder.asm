.section .text

.global _MAIN
.code 16	
.thumb:
.align	
_MAIN:
push {%r7}
push {%r6}
push {%r5}
push {%r4}
adr %r1, KEYLEN
ldrB %r1, [%r1]

adr %r3, DATALEN
ldrh %r3, [%r3]
adr %r0, KEY

eor %r4, %r4 
eor %r5, %r5 
adr %r2, DATA

label1:
ldrb %r6, [%r0]
ldrb %r7, [%r2]
eor %r6, %r6, %r7
strb %r6, [%r2]

add %r0, #1
add %r2, #1
add %r4, #1
add %r5, #1
cmp %r4, %r1
bne label_norekey
eor %r4, %r4
adr %r0, KEY


label_norekey:
cmp %r5, %r3
bne label1


adr %r2, DATA
pop {%r4}
pop {%r5}
pop {%r6}
pop {%r7}
add %r2, #1
mov %pc, %r2

.align
DATALEN: .hword ${DATALEN}
.byte 0xff
.byte 0xff
KEYLEN: .byte ${KEYLEN}
.byte 0xff
.byte 0xff
.byte 0xff

.align
KEY: ${KEY}
.align
DATA: 
.byte 0xaa
.byte 0xaa
.byte 0xaa
.byte 0xaa
.byte 0xaa
.byte 0xaa
.byte 0xaa
.byte 0xaa
